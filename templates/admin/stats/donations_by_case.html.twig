{% extends 'base.html.twig' %}

{% block title %}Stats — Dons par cas{% endblock %}

{% block body %}
  <div class="d-flex flex-column flex-md-row justify-content-between align-items-start align-items-md-center gap-3 mb-4">
    <div>
      <h1 class="h4 fw-bold mb-0">Statistiques des dons par cas</h1>
      <small class="text-muted">Totaux, nombre de dons, moyenne, dernier don</small>
    </div>
  </div>

  <div class="card miaza-card mb-4">
    <div class="card-body">
      <form method="get" class="row g-3 align-items-end">
        <div class="col-md-6">
          <label class="form-label small text-muted">Filtrer par cas</label>
          <select class="form-select" name="case" onchange="this.form.submit()">
            <option value="">Tous les cas</option>
            {% for c in cases %}
              <option value="{{ c.id }}" {{ selectedCaseId == c.id ? 'selected' : '' }}>
                #{{ c.id }} — {{ c.title }}
              </option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-6 d-flex gap-2 justify-content-md-end">
          <div class="kpi">
            <div class="muted small">Total dons</div>
            <div class="value">{{ grandTotal|number_format(2, '.', ' ') }} TND</div>
          </div>
          <div class="kpi">
            <div class="muted small">Nombre de dons</div>
            <div class="value">{{ grandCount }}</div>
          </div>
        </div>
      </form>
    </div>
  </div>

  {% if stats is empty %}
    <div class="alert alert-warning">Aucune statistique disponible (pas de dons).</div>
  {% else %}
    <div class="card miaza-card">
      <div class="card-body">
        <div class="table-responsive">
          <table class="table align-middle mb-0">
            <thead>
              <tr>
                <th>Cas</th>
                <th>Catégorie</th>
                <th class="text-end">Dons (nb)</th>
                <th class="text-end">Total</th>
                <th class="text-end">Moyenne</th>
              </tr>
            </thead>
            <tbody>
              {% for row in stats %}
                <tr>
                  <td>
                    <div class="fw-bold">{{ row.caseTitle }}</div>
                    <div class="small text-muted">#{{ row.caseId }} {% if row.isUrgent %} • Urgent{% endif %} • {{ row.viewsCount }} vues</div>
                  </td>
                  <td>{{ row.categoryName }}</td>
                  <td class="text-end">{{ row.donationsCount }}</td>
                  <td class="text-end fw-bold">{{ row.totalAmount|number_format(2, '.', ' ') }} TND</td>
                  <td class="text-end">{{ row.avgAmount|number_format(2, '.', ' ') }} TND</td>
                </tr>
              {% endfor %}
            </tbody>
          </table>
        </div>
      </div>
    </div>
  {% endif %}
{% endblock %}
