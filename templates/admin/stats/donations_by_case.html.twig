{% extends 'base.html.twig' %}

{% block title %}Stats — Donations by Case{% endblock %}

{% block body %}
<div class="miaza-admin-header mb-4">
    <div class="d-flex flex-column flex-md-row align-items-md-center justify-content-between gap-3">
        <div>
            <span class="miaza-pill"><i class="bi bi-graph-up me-1"></i> Admin</span>
            <h1 class="h4 fw-bold mt-2 mb-1">Donations by Case</h1>
            <p class="text-muted mb-0">Local donations + Cha9a9a progress (live)</p>
        </div>

        <form method="get" class="d-flex gap-2 align-items-center">
            <select name="case" class="form-select" style="min-width:260px">
                <option value="">All cases</option>
                {% for c in cases %}
                    <option value="{{ c.id }}" {{ (selectedCaseId == c.id) ? 'selected' : '' }}>
                        {{ c.title }}
                    </option>
                {% endfor %}
            </select>
            <button class="btn btn-primary" type="submit">
                <i class="bi bi-funnel me-1"></i> Filter
            </button>
            <a class="btn btn-outline-primary" href="{{ path('admin_stats_donations_by_case') }}">
                <i class="bi bi-arrow-counterclockwise me-1"></i> Reset
            </a>
        </form>
    </div>

    <div class="row g-2 mt-3">
        <div class="col-12 col-md-4">
            <div class="miaza-kpi">
                <div class="small text-muted">Local total</div>
                <div class="fw-bold">{{ grandTotal|number_format(0, '.', ' ') }} DT</div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="miaza-kpi">
                <div class="small text-muted">Local donations count</div>
                <div class="fw-bold">{{ grandCount }}</div>
            </div>
        </div>
        <div class="col-12 col-md-4">
            <div class="miaza-kpi">
                <div class="small text-muted">Cha9a9a total collected</div>
                <div class="fw-bold" id="cha9a9aGrandCollected">—</div>
            </div>
        </div>
    </div>
</div>
<div class="row g-3 mb-4">
  <div class="col-12">
    <div class="card miaza-card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="fw-bold mb-0">Local vs Cha9a9a (DT) — by case</h6>
          <span class="text-muted small">Bars</span>
        </div>
        <div style="height: 340px;">
          <canvas id="chartLocalVsCha9a9a"></canvas>
        </div>
      </div>
    </div>
  </div>

  <div class="col-12">
    <div class="card miaza-card">
      <div class="card-body">
        <div class="d-flex align-items-center justify-content-between mb-3">
          <h6 class="fw-bold mb-0">Cha9a9a funding percent — by case</h6>
          <span class="text-muted small">Line</span>
        </div>
        <div style="height: 280px;">
          <canvas id="chartCha9a9aPercent"></canvas>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="card miaza-card">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table miaza-table mb-0" id="statsTable">
                <thead class="table-light">
                <tr>
                    <th style="min-width:240px">Case</th>
                    <th class="text-end" style="min-width:170px">Local donations</th>
                    <th class="text-center" style="min-width:120px">Local count</th>

                    <th class="text-center" style="min-width:120px">Cha9a9a %</th>
                    <th class="text-end" style="min-width:220px">Cha9a9a collected / goal</th>
                    <th class="text-center" style="min-width:140px">Participants</th>
                </tr>
                </thead>

                <tbody>
                {% for row in stats %}
<tr data-case-title="{{ row.caseTitle|e('html_attr') }}"
    data-cha-url="{{ row.cha9a9aLink|default('')|e('html_attr') }}">
                        <td class="fw-semibold">{{ row.caseTitle }}</td>
                        <td class="text-end">{{ row.totalAmount|number_format(0, '.', ' ') }} DT</td>
                        <td class="text-center">{{ row.donationsCount }}</td>

                        <td class="text-center">
                            <span class="cha9a9a-percent miaza-pill-light text-muted">—</span>
                        </td>
                        <td class="text-end">
                            <span class="cha9a9a-money text-muted">—</span>
                        </td>
                        <td class="text-center">
                            <span class="cha9a9a-participants text-muted">—</span>
                        </td>
                    </tr>
                {% else %}
                    <tr>
                        <td colspan="6" class="text-center py-4 text-muted">No stats available.</td>
                    </tr>
                {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<script>
(async function(){
  const rows = document.querySelectorAll('tr[data-case-title]');
  const cache = new Map();

  // For charts
  const labels = [];
  const localTotals = [];
  const chaCollected = [];
  const chaPercent = [];

  function fmt(n){
    if(n === null || n === undefined) return "—";
    return new Intl.NumberFormat('fr-TN').format(n);
  }

  function toNumberSafe(s){
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  }

  function setBadge(el, text, ok=true){
    el.classList.remove('text-muted');
    el.classList.add(ok ? 'miaza-pill-light' : 'miaza-pill-danger');
    el.textContent = text;
  }

  // Helper: read local total from table cell (DT)
  function readLocalDT(tr){
    const td = tr.querySelector('td.text-end'); // local donations cell
    if(!td) return 0;
    // Example: "200 DT" -> keep digits only
    const digits = (td.innerText || '').replace(/[^\d]/g,'');
    return digits ? parseInt(digits, 10) : 0;
  }

  // Fill table + collect chart data
  for(const tr of rows){
    const title = tr.dataset.caseTitle;
    if(!title) continue;

    const percentEl = tr.querySelector('.cha9a9a-percent');
    const moneyEl = tr.querySelector('.cha9a9a-money');
    const partEl = tr.querySelector('.cha9a9a-participants');

    const local = readLocalDT(tr);

    // Store labels + local totals for charts always
    labels.push(title);
    localTotals.push(local);

    if(cache.has(title)){
      fill(tr, cache.get(title), local);
      continue;
    }

    try{
const chaUrl = (tr.dataset.chaUrl || '').trim();
const endpoint = chaUrl
  ? ("/api/cha9a9a/stats-by-url?url=" + encodeURIComponent(chaUrl))
  : ("/api/cha9a9a/stats?name=" + encodeURIComponent(title));

const res = await fetch(endpoint);
      const data = await res.json();
      cache.set(title, data);
      fill(tr, data, local);
    }catch(e){
      fill(tr, { error: true }, local);
    }
  }

  // Render charts AFTER data is collected
  renderCharts(labels, localTotals, chaCollected, chaPercent);

  function fill(tr, data, local){
    const percentEl = tr.querySelector('.cha9a9a-percent');
    const moneyEl = tr.querySelector('.cha9a9a-money');
    const partEl = tr.querySelector('.cha9a9a-participants');

    if(!percentEl || !moneyEl || !partEl) return;

    // Default for charts if not found
    let collected = 0;
    let pct = 0;

    if(data.error){
      setBadge(percentEl, "Error", false);
      moneyEl.textContent = "Error";
      partEl.textContent = "—";
      collected = 0;
      pct = 0;
    } else if ((data.collected ?? 0) === 0 && (data.goal ?? 0) === 0) {
      setBadge(percentEl, "Not found", false);
      moneyEl.textContent = "Not found";
      partEl.textContent = "—";
      collected = 0;
      pct = 0;
    } else {
      const percent = data.percent ?? 0;
      setBadge(percentEl, percent + "%", true);
      moneyEl.textContent = fmt(data.collected) + " / " + fmt(data.goal) + " DT";
      partEl.textContent = fmt(data.participants);

      collected = toNumberSafe(data.collected ?? 0);
      pct = toNumberSafe(data.percent ?? 0);
    }

    // Push to chart arrays in the same order as labels
    chaCollected.push(collected);
    chaPercent.push(pct);
  }

  function renderCharts(labels, localTotals, chaCollected, chaPercent){
    const ctx1 = document.getElementById('chartLocalVsCha9a9a');
    const ctx2 = document.getElementById('chartCha9a9aPercent');

    if(ctx1){
      new Chart(ctx1, {
        type: 'bar',
        data: {
          labels,
          datasets: [
            {
              label: 'Local donations (DT)',
              data: localTotals
            },
            {
              label: 'Cha9a9a collected (DT)',
              data: chaCollected
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: (c) => `${c.dataset.label}: ${new Intl.NumberFormat('fr-TN').format(c.raw)} DT`
              }
            }
          },
          scales: {
            x: { ticks: { maxRotation: 0, autoSkip: true } },
            y: {
              beginAtZero: true,
              ticks: {
                callback: (v) => new Intl.NumberFormat('fr-TN').format(v)
              }
            }
          }
        }
      });
    }

    if(ctx2){
      new Chart(ctx2, {
        type: 'line',
        data: {
          labels,
          datasets: [
            {
              label: 'Cha9a9a % funded',
              data: chaPercent,
              tension: 0.25,
              pointRadius: 4
            }
          ]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: { position: 'top' },
            tooltip: {
              callbacks: {
                label: (c) => `${c.raw}%`
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              max: 100,
              ticks: { callback: (v) => v + '%' }
            }
          }
        }
      });
    }
  }
})();
</script>
<script>
  // Update grand total collected from Cha9a9a (sum of all cases)
  (async function(){
    try{
      const res = await fetch("/api/cha9a9a/grand-total");
      const data = await res.json();
      const el = document.getElementById('cha9a9aGrandCollected');
      if(el){
        el.textContent = data.grandTotal ? new Intl.NumberFormat('fr-TN').format(data.grandTotal) + " DT" : "—";
      }
    }catch(e){
      const el = document.getElementById('cha9a9aGrandCollected');
      if(el){
        el.textContent = "Error";
      }
    }
    })();
</script>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

{% endblock %}
